<div class="appointment-form-container">
  <!-- En-tête -->
  <div class="header">
    <h1>{{ isEditMode ? 'Modifier le Rendez-vous' : 'Nouveau Rendez-vous' }}</h1>
  </div>

  <!-- Formulaire -->
  <mat-card class="form-card">
    <mat-card-content>
      <form [formGroup]="appointmentForm" (ngSubmit)="onSubmit()" class="appointment-form">
        
        <!-- Informations du patient et médecin -->
        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Patient *</mat-label>
            <mat-select formControlName="patientId" [disabled]="loading">
              <mat-option *ngFor="let patient of patients" [value]="patient.id">
                {{ getPatientDisplayName(patient) }}
              </mat-option>
            </mat-select>
            <mat-error *ngIf="appointmentForm.get('patientId')?.hasError('required')">
              {{ getErrorMessage('patientId') }}
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Médecin *</mat-label>
            <mat-select formControlName="doctorId" [disabled]="loading">
              <mat-option *ngFor="let doctor of doctors" [value]="doctor.id">
                {{ getDoctorDisplayName(doctor) }}
              </mat-option>
            </mat-select>
            <mat-error *ngIf="appointmentForm.get('doctorId')?.hasError('required')">
              {{ getErrorMessage('doctorId') }}
            </mat-error>
          </mat-form-field>
        </div>

        <!-- Date et type -->
        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Date *</mat-label>
            <input matInput [matDatepicker]="datePicker" formControlName="date" [disabled]="loading">
            <mat-datepicker-toggle matSuffix [for]="datePicker"></mat-datepicker-toggle>
            <mat-datepicker #datePicker></mat-datepicker>
            <mat-error *ngIf="appointmentForm.get('date')?.hasError('required')">
              {{ getErrorMessage('date') }}
            </mat-error>
            <mat-error *ngIf="appointmentForm.get('date')?.hasError('pastDate')">
              {{ getErrorMessage('date') }}
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Type de rendez-vous *</mat-label>
            <mat-select formControlName="type" [disabled]="loading">
              <mat-option *ngFor="let type of typeOptions" [value]="type">
                {{ getTypeDisplayName(type) }}
              </mat-option>
            </mat-select>
            <mat-error *ngIf="appointmentForm.get('type')?.hasError('required')">
              {{ getErrorMessage('type') }}
            </mat-error>
          </mat-form-field>
        </div>

        <!-- Heures -->
        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Heure de début *</mat-label>
            <input matInput type="time" formControlName="startTime" [disabled]="loading">
            <mat-error *ngIf="appointmentForm.get('startTime')?.hasError('required')">
              {{ getErrorMessage('startTime') }}
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Heure de fin *</mat-label>
            <input matInput type="time" formControlName="endTime" [disabled]="loading">
            <mat-error *ngIf="appointmentForm.get('endTime')?.hasError('required')">
              {{ getErrorMessage('endTime') }}
            </mat-error>
            <mat-error *ngIf="appointmentForm.get('endTime')?.hasError('invalidTimeRange')">
              {{ getErrorMessage('endTime') }}
            </mat-error>
          </mat-form-field>
        </div>

        <!-- Salle et notes -->
        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Salle *</mat-label>
            <mat-select formControlName="room" [disabled]="loading">
              <mat-option *ngFor="let room of rooms" [value]="room">
                {{ room }}
              </mat-option>
            </mat-select>
            <mat-error *ngIf="appointmentForm.get('room')?.hasError('required')">
              {{ getErrorMessage('room') }}
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Notes</mat-label>
            <textarea matInput formControlName="notes" rows="3" 
                      placeholder="Informations supplémentaires..." [disabled]="loading"></textarea>
          </mat-form-field>
        </div>

        <!-- Message de conflit -->
        <div *ngIf="hasConflict" class="conflict-warning">
          <mat-icon>warning</mat-icon>
          <span>{{ conflictMessage }}</span>
        </div>

        <!-- Actions -->
        <div class="form-actions">
          <button type="button" mat-button (click)="onCancel()" [disabled]="submitting">
            <mat-icon>cancel</mat-icon>
            Annuler
          </button>
          
          <button type="submit" mat-raised-button color="primary" 
                  [disabled]="appointmentForm.invalid || submitting || hasConflict">
            <mat-icon *ngIf="!submitting">{{ isEditMode ? 'save' : 'add' }}</mat-icon>
            <mat-spinner *ngIf="submitting" diameter="20"></mat-spinner>
            {{ isEditMode ? 'Mettre à jour' : 'Créer' }}
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>

  <!-- Indicateur de chargement -->
  <div *ngIf="loading" class="loading-overlay">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Chargement...</p>
  </div>
</div>
